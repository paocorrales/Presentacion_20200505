---
title: "Using satellite data for evaluating and improving of high-resolution numerical forecasts of deep convective systems"
#subtitle: "⚔<br/>with xaringan"
author: "Paola Corrales"
institute: "CIMA UBA-CONICET"
date: "2020 05 05"
output:
  xaringan::moon_reader:
    css: [default, "verde.css", default-fonts]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
---

```{r setup, include=FALSE, eval=TRUE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(fig.retina = 3,
                      cache=TRUE,
                      echo=FALSE, 
                      warning=FALSE)

library(tidyverse)
library(metR)
library(data.table)
library(lubridate)
library(scattermore)
source("help_functions.R")
source("postprocesamiento.R")
source("goes_functions.R")

map <- rnaturalearth::ne_states(country = c("argentina", "Brazil", "Chile", "Uruguay", "Paraguay", "Bolivia"), returnclass = "sf")

geom_mapa <- function() {
  geom_sf(data = map, fill = NA, color = "black", size = 0.2, inherit.aes = FALSE)
}
```

class: inverse
name: goals

# General Goals

The main goal is to contribute to the development of a system of short-term forecasting of events associated with deep wet convection in southeastern South America. The following specific objectives are proposed:

--

1. Assess different configurations of numerical models with explicit representation of convection, using radar and satellite data.

--

2. Improve the quality of initial conditions for explicit convection forecasts by assimilating conventional, satellite and radar data.

---
name: case

# Case Study: November 22th, 2020

.left-column[IOP08 (Severe, Upscale Growth handoff) of the RELAMPAGO field campaign] 

.right-column[![gif](fig/caso_20181122.gif)]

---
name: model-conf

# Model and ensemble configuration
.pull-left[ 
- **Resolution:** 10 km.
- **Initial and boundary conditions:** GFS (deterministic 0.5º)
- **Ensemble:** 60 members with multi-physics and random perturbations. 
- 9 combinations of Cumulis and PBL **parameterizations:**

| Cumulus | PBL |
|---|---|
| KB | YSU |
| GB | MYJ |
| BMJ | MYNN2 |
]

.pull-right[ 
```{r echo=FALSE, fig.width=7, fig.height=7}
ReadNetCDF("/home/paola.corrales/datosmunin/EXP/E4/ANA/20181120180000/analysis.ensmean", 
           vars = c("HGT", "XLAT", "XLONG")) %>% 
  setnames(c("HGT", "XLAT", "XLONG"), c("hgt", "lat", "lon")) %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = hgt), size = 5) +
  scale_color_distiller(name = NULL, 
                        type = "seq", 
                        palette = "RdYlGn", 
                        direction = -1,
                        guide = guide_colorstrip(barwidth = 20, 
                                                 barheight = 0.8)) +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, size = 0.5) +
  coord_sf(ylim = c(-41, -20), xlim = c(-75, -52.5)) +
  labs(
    subtitle = "Model domain",
    x = "Longitude", 
    y = "Latitude") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom") 
```

]

---
name: cycle
background-image: url("fig/analysis_cycle.svg")
background-position: center
background-size: cover

# Assimilation Cycle

---
name: exp-config

# Experiments configuration

.pull-left[


| Obs type | CONV | AUT | SATWND |
|:---:|:---:|:---:|:---:|
| ADPSFC | ✔ ️| ✔️ |  ✔️ |
| AUTSFC |   | ✔️ | ✔️ |
| ADPUPA | ✔  | ✔ ️|✔️ |
| AIRCFT | ✔️ | ✔ | ✔️  |
| AIRCAR | ✔️ | ✔ | ✔️  |
| SFCSHP | ✔️ | ✔  | ✔️  |
| ASCATW | ✔️ | ✔ | ✔️  |
| SATWND |   |   | ✔️  |


]


.pull-right[ 
```{r echo=FALSE}
dominio <- ReadNetCDF("/home/paola.corrales/datosmunin/EXP/E4/ANA/20181120180000/analysis.ensmean", vars = c("XLAT", "XLONG")) %>% 
  setnames(c("XLAT", "XLONG"), c("lat", "lon"))

square <- dominio %>% 
  copy() %>% 
  .[, square1 := west_east %in% range(west_east) , by = .(south_north)] %>% 
  .[, square2 := south_north %in% range(south_north) , by = .(west_east)] %>% 
  .[square1 | square2] 


obsAUT <- lapply(Sys.glob("analisis/diagfiles/E5/asim*ensmean"), function(f) {
  date_time <- ymd_hms(substr(basename(f), 11, 24))
  ens <- substr(basename(f), 29, 32)
  fread(f, na.strings = c("0.100E+11", "-0.100E+06", "-99999.90", "-100000.00")) %>% 
    .[, date.time := date_time] %>% 
    .[, ens := ens] %>% 
    .[]
}) %>% 
  rbindlist() %>% 
  .[, c("V2", "V4") := NULL] 

colnames(obsAUT) <- c("var", "stationID", "type", "dhr", "lat", "lon", "pressure", "usage.flag", "flag", "obs", "obs.guess", "obs2", "obs.guess2", "rerr", "date.time", "ens") 


obsCONV <- lapply(Sys.glob("analisis/diagfiles/E4/asim*ensmean"), function(f) {
  date_time <- ymd_hms(substr(basename(f), 11, 24))
  ens <- substr(basename(f), 29, 32)
  fread(f, na.strings = c("0.100E+11", "-0.100E+06", "-99999.90", "-100000.00")) %>% 
    .[, date.time := date_time] %>% 
    .[, ens := ens] %>% 
    .[]
}) %>% 
  rbindlist() %>% 
  .[, c("V2", "V4") := NULL] 

colnames(obsCONV) <- c("var", "stationID", "type", "dhr", "lat", "lon", "pressure", "usage.flag", "flag", "obs", "obs.guess", "obs2", "obs.guess2", "rerr", "date.time", "ens") 


oficiales <- obsCONV[type != 290, unique(stationID)]

no_oficiales <- unique(obsAUT, by = c("stationID")) %>% 
  .[type != 290] %>% 
  .[!str_detect(stationID, "SMN")] %>%
  .[!stationID %in% oficiales & type != 290, stationID]

unique(obsAUT, by = c("stationID")) %>% 
  .[type != 290] %>% 
  .[!str_detect(stationID, "SMN")] %>% 
  ggplot(aes(ConvertLongitude(lon), lat)) +
  geom_sf(data = map, fill = NA, color = "black", inherit.aes = FALSE, , size = 0.5) +
  geom_point(alpha = 0.8, size = 2,
             aes(color = stationID %in% oficiales)) +
  scale_color_manual(name =  NULL, values = c("TRUE" = "#FD8002", "FALSE" = "#367DB7"),
                     breaks = c("FALSE", "TRUE"),
                     labels = c("Non-official (N = 820)","Official (N = 327)"))+
  geom_point(data = square, aes(lon, lat), size = 0.8) +
  coord_sf(ylim = c(-42, -19), xlim = c(-76, -51)) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = "Longitude", y = "Latitude") +
  theme_minimal(base_size = 16) + 
  theme(legend.position = "bottom")
```


]
---
class: center, inverse, middle

# Analysis comparison

---
name: rcrv-intro

## Reduced Centered Random Variable


The *Reduced Centered Random Variable* is defined as:

$$ y = \frac{y^o - m}{\sqrt{\sigma_o^2 +\sigma^ 2}} $$
The average of $y$ compute over all the realizations represent the weighted bias between the ensemble and observation $b = E[y]$.

The standar deviation of $y$ is a measure of systematic over- or under- dispersion of the ensemble. It measure the agreement of the ensemble spread and the specific observational error with the observed amplitude of the forecast error $d = \sqrt{\frac{M}{M-1} E[(y-b)^2]}$

A perfect system has no bias ( $b=0$ ) and dispersion equal to 1 ( $d=1$, con $d>1 \rightarrow underdispersive$ y $d<1 \rightarrow overdispersive$).


<!-- ```{r echo=FALSE} -->
<!-- fread("rcrv_uvt_superficie_temporal.csv") %>%  -->
<!--   .[, date := ymd_hms(date)] %>%  -->
<!--   melt(measure.vars = c("mean.y", "sd.y")) %>%  -->
<!--   ggplot(aes(date, value)) + -->
<!--   geom_hline(yintercept = c(0, 1), color = "darkgray") + -->
<!--   geom_line(aes(color = factor(type), linetype = variable)) + -->
<!--   scale_x_datetime(date_breaks = "6 hours", date_labels = "%H:%m %b %d") + -->
<!--   facet_wrap(~var, ncol = 1, scales = "free_y") + -->
<!--   labs(y = "Reduced Centered Random Variable", -->
<!--        subtitle = "Surface observations", -->
<!--        color = "Obs type", -->
<!--        linetype = "") + -->
<!--   theme_minimal() -->

<!-- fread("rcrv_uvt_superficie.csv") %>%  -->
<!--   knitr::kable() -->
<!-- ``` -->

---

name: rcrv-box-wind

### Wind 

```{r fig.align="center", fig.height=9, fig.width=16}

fread("uvt_rcrv_box.csv") %>% 
  .[var %in% c("u", "v")] %>% 
  .[, type.obs := type] %>% 
  ggplot(aes(ConvertLongitude(lon.box), lat.box)) +
  geom_raster(aes(fill = sd.y)) +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  scale_fill_viridis_c(breaks = seq(0, 4, 0.5),
                       limits = c(0, 4),
                       direction = -1,
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 20,
                                                barheight = 0.8)) +
  facet_grid(var~type.obs) +
  labs(
       caption = "Calculated over 2.5ºx2.5º boxes",
       x = "",
       y = "",
       fill = "") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```
---
name: rcrv-box-temp

### Temperature
```{r fig.align="center", fig.height=9, fig.width=16}
fread("uvt_rcrv_box.csv") %>% 
  .[var %in% c("t")] %>% 
  .[, type.obs := type] %>% 
  ggplot(aes(ConvertLongitude(lon.box), lat.box)) +
  geom_raster(aes(fill = sd.y)) +
  geom_mapa() +
  coord_sf(xlim = c(-75, -52), ylim = c(-42,-20)) +
  scale_fill_viridis_c(breaks = seq(0, 5, 0.5),
                       limits = c(0, 5),
                       direction = -1,
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 20,
                                                barheight = 0.8)) +
  facet_grid(var~type.obs) +
  labs(
       caption = "Calculated over 2.5ºx2.5º boxes",
       x = "",
       y = "",
       fill = "") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3)) 
```


---
name: rcrv-profile

```{r echo=FALSE, fig.align="center", fig.width=8, fig.height=8}
fread("rcrv_uvt_perfil.csv") %>% 
  melt(measure.vars = c("mean.y", "sd.y")) %>% 
  ggplot(aes(nivel.error, value)) +
  geom_hline(yintercept = c(0, 1), color = "darkgrey") +
  geom_line(aes(color = factor(type), linetype = variable)) +
  scale_x_level() +
  coord_flip() +
  facet_wrap(~ var, scales = "free_x") +
  labs(y = "Reduced Centered Random Variable",
       subtitle = "Sounding and aircraft observations",
       linetype = "",
       color = "Obs type") +
 theme_minimal(base_size = 16) 
```


---
name: mcape


```{r echo=FALSE, warning=FALSE, fig.align="center", fig.height=9, fig.width=14}
files <- list.files("analisis/mucape", full.names = TRUE) 
files <- files[-grep("E3", files)]

cape <- lapply(files, function(file) {
  details <- unglue::unglue(file, "analisis/mucape/mcape_ana_{exp}_{date}.nc")[[1]]
  
  ReadNetCDF(file, vars = c(value = "cape_2d")) %>% 
    .[, `:=`(exp = details$exp, 
             date = lubridate::ymd_hms(details$date))] %>%
    setnames(old = "mcape_mcin_lcl_lfc", new = "variable") %>% 
    .[]
}) %>% 
  rbindlist() %>% 
  .[variable %in% c("mcape", "mcin")] %>% 
  .[!is.finite(value), value := 0] 

coord <- ReadNetCDF(files[1], vars = c(lon = "XLONG")) %>% 
  .[, lat := ReadNetCDF(files[1], vars = c(lat = "XLAT"))$lat]

interpol <- function(x, y, z, ...) {
  IL <- interp::interp(x, y, z, ...)
  CJ(y = IL$y, x = IL$x)[, z := c(IL$z)] 
}

cape[date %in% ymd_h(c("2018-11-22 00",
                       #"2018-11-22 03", 
                       "2018-11-22 06"))] %>% 
  .[coord, on = .NATURAL] %>% 
  .[, interpol(lon, lat, value, nx = 50, ny = 50), by = .(date, exp, variable)] %>% 
  setnames(c("x", "y", "z"), c("lon", "lat", "value")) %>%
  dcast(lat + lon + exp + date ~ variable) %>% 
  na.omit() %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = round(mcape, 6)), na.fill = 0) +
  # geom_contour2(data = function(d) dcast(d, lat + lon + date ~ exp, value.var = "value")[, dif := E3 - E4],
  #   aes(z = dif), bins = 5)+
  scale_fill_distiller(name = "MCAPE", palette = "YlOrRd", direction = 1, 
                       # breaks = seq(500, 5000, 500),
                       guide = guide_colorstrip(barwidth = 30,
                                                barheight = 0.8)) +
  ggnewscale::new_scale_fill() +
  scale_color_viridis_d() +
  geom_contour_filled(aes(z = mcin), alpha = 0.4, breaks = c(300, 1000), fill = "grey30") +
  # geom_contour(aes(z = mcin), na.fill = 0, size = 0.5, color = "blue", 
  #              breaks = c(300)) +
  geom_mapa() +
  
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  facet_grid(date ~ exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", E6 = "SATWND"))) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  labs(fill = "MCAPE",
       x = "Longitude",
       y = "Latitude") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom", 
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))

```

---
name: temp

.pull-left[ 
```{r}
perfil_lev_E6 <- fread("analisis/perfil_lev_T_Q_ana_E6.csv") %>% 
  .[, date := ymd_hms(date)] 

perfil_lev_E4 <- fread("analisis/perfil_lev_T_Q_ana_E4.csv") %>% 
  .[, date := ymd_hms(date)] 

perfil_lev_E5 <- fread("analisis/perfil_lev_T_Q_ana_E5.csv") %>% 
  .[, date := ymd_hms(date)] 


perfiles <- perfil_lev_E4[perfil_lev_E5, on = c("lev", "date")] %>%
  .[perfil_lev_E6, on = c("lev", "date")] %>% 
  setnames(c("T", "QVAPOR", "i.T", "i.QVAPOR", "i.T.1", "i.QVAPOR.1"),
           c("T.E4", "Q.E4", "T.E5", "Q.E5", "T.E6", "Q.E6")) %>% 
  .[] %>% 
  .[, `:=`(T_E5_E4 = T.E5 - T.E4,
           T_E6_E5 = T.E6 - T.E5,
           Q_E5_E4 = Q.E5 - Q.E4,
           Q_E6_E5 = Q.E6 - Q.E5)]

perfiles  %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = T_E5_E4), breaks = seq(-1, 1, 0.2)) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-1, 1, 0.2),
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  labs(title = "Temperature difference (K)",
       subtitle = "AUT - CONV",
       x = "Time",
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```
]
.pull-right[ 
```{r}
perfiles  %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = T_E6_E5), breaks = seq(-0.2, 0.2, 0.05)) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-0.2, 0.2, 0.05),
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  labs(title = "Temperature difference (K)",
       subtitle = "SATWND - AUT",
       x = "Time",
       y = "Pressure level") +
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```
]

---

name: hum

.pull-left[ 
```{r}
perfiles %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = Q_E5_E4*1000), breaks = seq(-0.0004, 0.0016, 0.0002)*1000) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-0.0004, 0.0016, 0.0002)*1000,
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  labs(title = "Humidity difference (g/Kg)",
       subtitle = "AUT - CONV",
       y = "Pressure level",
       x = "Time") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))

```

]

.pull-right[ 

```{r}
perfiles %>% 
  ggplot(aes(date, lev)) +
  geom_contour_fill(aes(z = Q_E6_E5*1000), breaks = seq(-0.0002, 0.0002, 0.00002)*1000) +
  scale_fill_divergent(name = NULL,
                       breaks = seq(-0.0002, 0.0002, 0.00002)*1000,
                       guide = guide_colorstrip(inside = TRUE,
                                                barwidth = 25,
                                                barheight = 0.8)) +
  
  scale_y_level(name = "Pressure level", breaks = c(1000, 850, 750, 500, 300, 200, 100)) +
  scale_x_datetime(expand = c(0,0), date_labels = "%HZ \n %b-%d", date_breaks = "12 hours") +
  labs(title = "Humidity difference (g/Kg)",
       subtitle = "SATWND - AUT",
       y = "Pressure level",
       x = "Time") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))

```
]

---
name: hum-field

```{r warning=FALSE, fig.align="center", fig.height=9, fig.width=14, message=FALSE,}
fcsts <- expand_grid(fcsts = c("20181122000000", "20181122060000"),
                     exp = c("E4", "E5", "E6"))

q <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0("analisis/u_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(u = "uvmet")) %>% 
    .[, v := ReadNetCDF(paste0("analisis/v_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(v = "uvmet"), out = "vector")] %>% 
    .[, q := ReadNetCDF(paste0("analisis/q_", fcsts[f, 1], "_", fcsts[f, 2], ".nc"), vars = c(q = "QVAPOR"), out = "vector")] %>% 
    .[, date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist()

q[bottom_top <= 7, .(q = mean(q), u = u[bottom_top == 1], v = v[bottom_top == 1]), 
  by = .(south_north, west_east, date, exp)] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = q*1000)) +
  scale_color_distiller(name = NULL,
                        palette = "BrBG", direction = 1,
                        breaks = seq(0, 0.02, 0.002)*1000,
                        guide = guide_colorstrip(inside = FALSE,
                                                 barwidth = 30,
                                                 barheight = 0.8)) +
  geom_vector(aes(dx = u, dy = v), data = function(x) x[is.cross(south_north, west_east, 5)]) +
  scale_mag() +
  geom_sf(data = map, inherit.aes = FALSE, color = "black", fill = NA, size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  facet_grid(date ~ exp, labeller = labeller(exp = c(E4 = "CONV", E5 = "AUT", E6 = "SATWND"))) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(title = "Low level humidity (g/Kg)",
       x = "Longituted",
       y = "Latitude") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```
---

name: hum-diff

```{r fig.align="center", fig.height=9, fig.width=14, message=FALSE, warning=FALSE}
diff_q_spd <- q[bottom_top <= 7, .(q = mean(q), u = u[bottom_top == 1], v = v[bottom_top == 1]), 
                by = .(south_north, west_east, date, exp)] %>% 
  .[coord, on = c("south_north", "west_east")] %>% 
  .[, date := factor(date)] %>%
  melt(id.vars = c("lon", "lat", "date", "exp"), measure.vars = c("q", "u", "v")) %>% 
  dcast(lon + lat + date + variable ~ exp, value.var = "value") %>% 
  .[, diff_E6_E5 := E6 - E5] %>% 
  .[, diff_E5_E4 := E5 - E4]

diff_q_spd %>% 
  melt(measure.vars = c("diff_E6_E5", "diff_E5_E4"), variable.name = "diff") %>%
  dcast(lon + lat + date + diff ~ variable, value.var = "value") %>% 
  # .[date %in% c("2018-11-22 00:00:00", "2018-11-22 06:00:00")] %>% 
  ggplot(aes(lon, lat)) +
  geom_point(aes(color = q), breaks = seq(-0.01, 0.01, 0.002)) +
  scale_color_divergent(name = NULL,
                        breaks = seq(-0.01, 0.01, 0.002),
                        guide = guide_colorstrip(inside = FALSE,
                                                 barwidth = 0.8,
                                                 barheight = 20)) +
  geom_vector(aes(dx = u, dy = v), data = function(x) x[is.cross(lat, lon, 4)]) +
  scale_mag() +
  geom_sf(data = map, inherit.aes = FALSE, fill = NA, color = "black", size = 0.2) +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
    facet_grid(date ~ diff, labeller = labeller(diff = c(diff_E6_E5 = "SATWND - AUT",
                                                         diff_E5_E4 = "AUT - CONV"))) +
  scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0)) +
  labs(x = "Longituted",
    y = "Latitude") +
  theme_minimal(base_size = 16) +
  theme(panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3),
        strip.background = element_blank())
```


---
class: inverse, center, middle

# Forecast comparison

---

name: pp-acum

```{r fig.align="center", fig.height=9, fig.width=14}
files <- Sys.glob("../datosmunin2/IMERG_20181122/*")

pp_imerg <- lapply(files, function(f) {
  date <- str_extract(str_extract(f, "\\d{8}-"), "\\d{8}")
  start <- str_extract(str_extract(f, "S\\d{6}"), "\\d{6}")
  end <- str_extract(str_extract(f, "E\\d{6}"), "\\d{6}")
  
  pp <- ReadNetCDF(f, vars = c(pp = "Grid/precipitationCal"), 
                   subset = list("Grid/lon" = -80:-50,                                                                          "Grid/lat" = -45:-15)) %>% 
    .[, start_date := ymd_hms(paste(date, start))] %>% 
    .[, end_date := ymd_hms(paste(date, end))] %>% 
    .[]
}) %>% 
  rbindlist() %>% 
  setnames(c("Grid/lon", "Grid/lat"), c("lon", "lat"))

pp_imerg_acum <- pp_imerg %>% 
  .[start_date %between% c(as_datetime("2018-11-22 06:00:00"), 
                           as_datetime("2018-11-23 11:30:00")), 
                          .(pp = sum(pp)), by = .(lon, lat)]

fcsts <- expand_grid(fcsts = c("20181122000000", "20181122060000"),                     
                     exp = c("E4", "E5", "E6"))

pp <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- ReadNetCDF(paste0("analisis/pp_acum_", fcsts[f, 2], "_fcst", fcsts[f, 1], ".nc"), vars = c(pp = "__xarray_dataarray_variable__",
                                                                                                    lon = "XLONG",
                                                                                                    lat = "XLAT")) %>% 
    .[, init_date :=  ymd_hms(fcsts[f, 1])] %>% 
    .[, exp := fcsts[f, 2]] %>%  
    .[]
}) %>% 
  rbindlist()

pp_inter <- pp[, interp::interp(lon, lat, pp, output = "points", xo = pp_imerg_acum$lon, yo = pp_imerg_acum$lat), 
               by = .(init_date, exp)] %>% 
  setnames(c("x", "y", "z"), c("lon", "lat", "pp"))

pp_inter %>% 
  .[, init_date := factor(init_date)] %>% 
  # .[init_date == unique(init_date)[2] | init_date == unique(init_date)[4]] %>% 
  ggplot(aes(lon, lat)) +
  geom_contour_fill(aes(z = pp), breaks = seq(10, 300, 50), na.fill = 0) +
  scale_fill_gradient("FCST", low  = "white", high = "black",
                       # limits = c(0, 350),
                       oob = scales::squish,
                       breaks = seq(0, 300, 50),
                       guide = guide_colorstrip(barwidth = 20,
                                                barheight = 0.7)) +
  geom_contour(data = pp_imerg_acum, aes(z = pp, color = ..level..), 
               breaks = seq(0, 300, 50),
               size = 0.7) +
  scale_color_viridis_c("IMERG", direction = -1,
                        breaks = seq(0, 300, 50),
                        guide = guide_colorstrip(inside = TRUE,
                                                 barwidth = 20,
                                                barheight = 0.8)) +
  geom_mapa() +
  coord_sf(xlim = range(coord$lon), ylim = range(coord$lat)) +
  facet_grid(init_date ~ exp, 
             labeller = labeller(exp = c(E4 = "CONV", 
                                         E5 = "AUT", 
                                         E6 = "SATWND"),
                                 init_date = c("2018-11-22 00:00:00" = "Init time = 00Z", 
                                               "2018-11-22 06:00:00" = "Init time = 06Z"))) +
  labs(title = "Accumulated precipitation",
       subtitle = "11/22 06Z to 11/23 12Z",
       x = "Longitude",
       y = "Latitude") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.grid = element_line(linetype = 3))
```


---

name: pp-hov

```{r fig.align="center", fig.height=9, fig.width=14}
pp_imerg_hr <- copy(pp_imerg)[, `:=`(hora = hour(start_date),
                               dia = day(start_date))] %>% 
  .[start_date %between% c(as_datetime("2018-11-22 06:00:00"), as_datetime("2018-11-23 11:30:00")), 
    .(pp = sum(pp)), by = .(hora, dia, lon, lat)] %>% 
  .[lat %between% c(-34, -30), .(pp = mean(pp)), by = .(hora, dia, lon)] %>% 
  .[, date := make_datetime(2018, 11, dia, hora)] 

fcsts <- expand_grid(fcsts = c("20181122000000", "20181122060000"),
                     exp = c("E4", "E5", "E6"))

pp_hov <- lapply(seq_len(nrow(fcsts)), function(f) {
  
  tmp <- fread(paste0("analisis/pp_hov_fcst", fcsts[f, 1], "_", fcsts[f, 2], ".csv")) %>%
    # .[, pp := pp - pp[date == "2018-11-22T06:00:00Z"]] %>%
    .[, pp_10 := c(NA, diff(pp)), by = .(west_east, fcst, exp)] %>% 
    .[date %between% c("2018-11-22T06:00:00Z", "2018-11-23T12:00:00Z")] %>% 
    .[, date := ymd_hms(date)] %>% 
    .[, fcst := ymd_hms(fcst)] %>% 
    .[]
}) %>% 
  rbindlist()

pp_hov_acum <- copy(pp_hov)[, `:=`(hora = hour(date),
                               dia = day(date))] %>% 
  .[, .(pp = sum(pp_10)), by = .(hora, dia, west_east, fcst, exp)] %>% 
  .[, date := make_datetime(2018, 11, dia, hora)]

pp_hov_acum[coord[south_north == 120, .(west_east, lon)], on = c("west_east")] %>% 
  .[, fcst := factor(fcst)] %>% 
  # .[fcst == unique(fcst)[2] | fcst == unique(fcst)[4]] %>% 
  ggplot(aes(lon, date)) +
  geom_contour_fill(aes(z = round(pp, 6)), breaks = seq(0, 15, 1), na.fill = 0) +
  scale_fill_gradient("FCST", low  = "white", high = "black",
                       # limits = c(0, 350),
                       oob = scales::squish,
                       breaks = seq(0, 15, 3),
                       guide = guide_colorstrip(barwidth = 20,
                                                barheight = 0.7)) +
  geom_contour(data = pp_imerg_hr, aes(z = pp, color = ..level..), 
               breaks = seq(0, 20, 3),
               size = 0.7) +
  scale_color_viridis_c("IMERG", direction = -1,
                        breaks = seq(0, 20, 3),
                        guide = guide_colorstrip(inside = TRUE,
                                                 barwidth = 20,
                                                barheight = 0.8)) +
  facet_grid(fcst ~ exp, labeller = labeller(exp = c(E4 = "CONV", 
                                         E5 = "AUT", 
                                         E6 = "SATWND"),
                                 fcst = c("2018-11-22 00:00:00" = "Init time = 00Z", 
                                               "2018-11-22 06:00:00" = "Init time = 06Z"))) +
  scale_x_longitude(breaks = seq(-75, -55, 5), expand = c(0,0)) +
  scale_y_datetime(date_breaks = "6 hours", date_labels = "%b-%d %HZ") +
  labs(title = "Hovmöller of accumulated precipitation",
    subtitle = "34ºS to 30ºS latitud",
    x = "Longitud",
    y = "Time") +
  theme_minimal(base_size = 16) +
  theme(legend.position = "bottom",
        panel.ontop = TRUE,
        panel.grid = element_line(linetype = 3))
```

---

Place holder for FSS

---

Place holder for sounding

---